<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Didactax | Intelligent Knowledge System</title>
    <link rel="icon" href="./assets/logo.png" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        didact: {
                            main: '#059669',   /* Emerald 600 */
                            dark: '#064e3b',   /* Emerald 800 */
                            light: '#a7f3d0',  /* Emerald 200 */
                            subtle: '#ecfdf5', /* Emerald 50 */
                            bg: '#f8fafc',     /* Slate 50 */
                        }
                    },
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; color: #1e293b; overflow-x: hidden; }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.6);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }
        .glass-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(5, 150, 105, 0.1); }

        .modern-input { background: white; border: 1px solid #e2e8f0; transition: all 0.2s; }
        .modern-input:focus { border-color: #059669; box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1); outline: none; }

        /* Color Pickers */
        .color-wrapper { position: relative; overflow: hidden; cursor: pointer; }
        .color-wrapper input[type="color"] { position: absolute; left: -100%; top: -100%; width: 200%; height: 200%; opacity: 0; cursor: pointer; }

        /* Editor Styling */
        #editor-content { min-height: 550px; outline: none; transition: background-color 0.3s; }
        
        /* Headers */
        #editor-content h1.preview-title { font-size: 2.5rem; font-weight: 800; color: inherit; line-height: 1.1; margin-bottom: 0.5rem; font-family: 'Space Grotesk', sans-serif; }
        
        /* Meta / Labels Container (Header) */
        #editor-content div.preview-meta { margin-bottom: 1.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem; }
        #editor-content span.preview-badge { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; padding: 0.25rem 0.75rem; border-radius: 999px; background: #ecfdf5; color: #047857; letter-spacing: 0.05em; border: 1px solid #a7f3d0; }

        /* Raw Data Block (Body) */
        #editor-content div.metadata-block {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 2rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: #475569;
            display: grid;
            gap: 0.5rem;
        }
        #editor-content div.metadata-row { display: flex; border-bottom: 1px dashed #cbd5e1; padding-bottom: 0.25rem; }
        #editor-content div.metadata-row:last-child { border-bottom: none; padding-bottom: 0; }
        #editor-content span.meta-key { font-weight: 700; color: #334155; min-width: 120px; }

        /* Content Body */
        #editor-content ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 1rem; }
        #editor-content ol { list-style-type: decimal; margin-left: 1.5rem; margin-bottom: 1rem; }
        #editor-content blockquote { border-left: 4px solid #059669; padding-left: 1rem; color: #64748b; font-style: italic; background: rgba(240, 253, 244, 0.5); padding: 0.5rem 1rem; border-radius: 0 0.5rem 0.5rem 0; margin-bottom: 1rem; }
        #editor-content b, #editor-content strong { font-weight: 700; }
        #editor-content p { margin-bottom: 1rem; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #059669; }

        #three-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .type-toggle.active { background-color: #059669; color: white; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3); }
        .dashboard-row { transition: all 0.2s ease-in-out; }
        .dashboard-row:hover { transform: scale(1.01); border-color: #a7f3d0; }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col relative font-sans">

    <canvas id="three-canvas"></canvas>

    <div id="modal-overlay" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-slate-900/40 backdrop-blur-sm">
        <div class="glass-card p-8 rounded-3xl max-w-sm w-full text-center animate-slide-up bg-white">
            <h3 id="modal-title" class="text-2xl font-display font-bold text-slate-800 mb-2">Notice</h3>
            <div id="modal-msg" class="text-slate-500 mb-6 text-sm"></div>
            <div class="flex justify-center gap-3">
                <button id="modal-cancel" class="hidden px-6 py-2 rounded-xl border border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition">Cancel</button>
                <button id="modal-ok" class="px-8 py-2 rounded-xl bg-didact-main text-white font-bold hover:bg-didact-dark shadow-lg shadow-emerald-500/30 transition">Okay</button>
            </div>
        </div>
    </div>

    <section id="view-auth" class="fixed inset-0 z-50 flex items-center justify-center px-4 bg-slate-50/80 backdrop-blur-xl transition-all duration-500">
        <div class="glass-card max-w-md w-full p-10 rounded-[2rem] text-center relative overflow-hidden shadow-2xl">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-emerald-400 to-cyan-500"></div>
            <div class="w-20 h-20 bg-emerald-100 rounded-2xl mx-auto mb-6 flex items-center justify-center text-4xl text-emerald-600 shadow-emerald-200 shadow-lg">
                <i class="fas fa-fingerprint"></i>
            </div>
            <h1 class="text-4xl font-display font-bold text-slate-800 mb-2 tracking-tight">Didactax.</h1>
            <p class="text-slate-500 mb-8 font-light">Your Secure Intellectual Vault</p>
            <div id="auth-form-container" class="space-y-4">
                <input type="password" id="auth-pass" class="modern-input w-full p-4 rounded-xl text-lg mt-1" placeholder="Access Passkey">
                <div id="reg-fields" class="hidden text-left space-y-4 animate-slide-up">
                     <input type="password" id="auth-pass-confirm" class="modern-input w-full p-4 rounded-xl text-lg mt-1" placeholder="Confirm Passkey">
                </div>
                <button id="auth-btn" onclick="handleAuth()" class="w-full py-4 rounded-xl bg-didact-main text-white font-bold text-lg shadow-xl shadow-emerald-500/20 hover:bg-didact-dark hover:scale-[1.02] transition transform mt-4">Unlock System</button>
                <p id="auth-subtext" class="text-sm text-slate-400 mt-6 cursor-pointer hover:text-emerald-600 transition" onclick="toggleAuthMode()">First time? Create access key.</p>
            </div>
        </div>
    </section>

    <div id="app-wrapper" class="hidden flex-col min-h-screen">
        
        <nav class="fixed top-0 w-full z-40 glass-panel">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <div class="flex items-center gap-3 cursor-pointer group" onclick="router('home')">
                        <div class="w-10 h-10 bg-gradient-to-br from-didact-main to-emerald-400 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-500/20 group-hover:rotate-12 transition">
                            <i class="fas fa-brain text-white text-lg"></i>
                        </div>
                        <span class="text-2xl font-display font-bold text-slate-800 tracking-tight">Didactax</span>
                    </div>
                    <div class="hidden md:flex items-center space-x-1 bg-white/50 p-1.5 rounded-2xl border border-white/60 backdrop-blur-md shadow-sm">
                        <button onclick="router('home')" class="px-6 py-2 rounded-xl text-sm font-bold text-slate-600 hover:bg-white hover:text-emerald-700 hover:shadow-md transition">Home</button>
                        <button onclick="router('dashboard')" class="px-6 py-2 rounded-xl text-sm font-bold text-slate-600 hover:bg-white hover:text-emerald-700 hover:shadow-md transition">Dashboard</button>
                    </div>
                    <button onclick="handleLogout()" class="w-10 h-10 rounded-full flex items-center justify-center text-slate-400 hover:bg-red-50 hover:text-red-500 transition" title="Lock System"><i class="fas fa-lock"></i></button>
                </div>
            </div>
        </nav>

        <main class="flex-grow pt-28 px-4 pb-12 w-full max-w-7xl mx-auto z-10">
            
            <section id="view-home" class="animate-slide-up">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center mb-24 mt-10">
                    <div>
                        <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-emerald-50 border border-emerald-100 text-emerald-700 font-bold text-xs uppercase tracking-wider mb-6">
                            <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Local • Secure • Intelligent
                        </div>
                        <h1 class="text-6xl md:text-7xl font-display font-bold mb-6 leading-[1.1] text-slate-900">
                            Structure your <br>
                            <span class="text-transparent bg-clip-text bg-gradient-to-r from-emerald-600 to-teal-500">Intellectual Growth</span>
                        </h1>
                        <p class="text-xl text-slate-500 mb-8 max-w-lg leading-relaxed">
                            Didactax is the secure, offline-first system to convert raw information into structured summaries and actionable notes.
                        </p>
                        <div class="flex flex-wrap gap-4">
                            <button onclick="router('dashboard')" class="px-8 py-4 rounded-xl bg-didact-main text-white font-bold text-lg hover:-translate-y-1 transition shadow-lg shadow-emerald-500/30">
                                Enter Dashboard <i class="fas fa-arrow-right ml-2 text-sm"></i>
                            </button>
                            <button onclick="createQuick('Note')" class="px-8 py-4 rounded-xl bg-white border border-slate-200 text-slate-700 font-bold text-lg hover:bg-slate-50 transition shadow-sm">
                                <i class="fas fa-plus mr-2 text-emerald-500"></i> Quick Note
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mb-20">
                    <h2 class="text-3xl font-display font-bold text-slate-800 mb-8 text-center">System Architecture</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="glass-card p-8 rounded-[2rem] bg-white">
                            <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center text-emerald-600 mb-6 text-xl"><i class="fas fa-shield-alt"></i></div>
                            <h3 class="text-xl font-bold text-slate-800 mb-3">Why Didactax?</h3>
                            <ul class="space-y-3 text-sm text-slate-500">
                                <li class="flex items-start gap-2"><i class="fas fa-check text-emerald-500 mt-1"></i> <strong>Total Privacy:</strong> Data never leaves your device. Stored in IndexedDB.</li>
                                <li class="flex items-start gap-2"><i class="fas fa-check text-emerald-500 mt-1"></i> <strong>Zero Latency:</strong> No server calls, instant updates.</li>
                            </ul>
                        </div>

                        <div class="glass-card p-8 rounded-[2rem] bg-white">
                            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-blue-600 mb-6 text-xl"><i class="fas fa-magic"></i></div>
                            <h3 class="text-xl font-bold text-slate-800 mb-3">What it does</h3>
                            <ul class="space-y-3 text-sm text-slate-500">
                                <li class="flex items-start gap-2"><i class="fas fa-check text-blue-500 mt-1"></i> <strong>Live Synthesis:</strong> Converts inputs into formatted documents instantly.</li>
                                <li class="flex items-start gap-2"><i class="fas fa-check text-blue-500 mt-1"></i> <strong>Smart Export:</strong> Save locally or PDF export.</li>
                            </ul>
                        </div>

                        <div class="glass-card p-8 rounded-[2rem] bg-white">
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center text-purple-600 mb-6 text-xl"><i class="fas fa-code"></i></div>
                            <h3 class="text-xl font-bold text-slate-800 mb-3">How it works</h3>
                            <p class="text-sm text-slate-500 leading-relaxed mb-4">
                                We utilize the browser's native capabilities to create a persistent, encrypted local vault. Your passkey acts as the salt for data access.
                            </p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="view-dashboard" class="hidden space-y-8 animate-slide-up">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <div class="lg:col-span-2 glass-card rounded-[2rem] p-8 relative overflow-hidden group flex items-center gap-6">
                        <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition">
                            <button onclick="editProfile()" class="text-xs bg-slate-100 px-3 py-1.5 rounded-lg hover:bg-emerald-500 hover:text-white transition shadow-sm font-bold"><i class="fas fa-pen mr-1"></i> Edit</button>
                        </div>
                        <div class="w-20 h-20 rounded-2xl bg-gradient-to-tr from-emerald-500 to-teal-400 flex items-center justify-center text-3xl font-bold text-white shadow-xl shadow-emerald-500/20">
                            <span id="profile-avatar">U</span>
                        </div>
                        <div>
                            <h2 id="profile-name" class="text-2xl font-bold text-slate-800">User</h2>
                            <p id="profile-role" class="text-emerald-700 font-bold text-xs uppercase tracking-wider mb-1">Student</p>
                            <p id="profile-bio" class="text-sm text-slate-400">Lifelong Learner</p>
                        </div>
                    </div>
                    <div class="glass-card rounded-[2rem] p-8 flex flex-col justify-center items-center text-center">
                        <h3 class="text-slate-400 text-xs font-bold uppercase tracking-widest">Momentum</h3>
                        <div class="text-5xl font-display font-bold text-slate-800 mt-3 flex items-center gap-2">
                            <span id="streak-count">0</span> <span class="text-2xl text-orange-500 animate-pulse"><i class="fas fa-fire"></i></span>
                        </div>
                        <p class="text-xs text-slate-400 mt-2">Consecutive Days</p>
                    </div>
                    <div class="glass-card rounded-[2rem] p-6 relative">
                         <h3 class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-4">System Log</h3>
                         <ul id="activity-log" class="text-xs space-y-3 text-slate-500 h-28 overflow-y-auto custom-scrollbar"></ul>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button onclick="createQuick('Summary')" class="col-span-1 bg-emerald-600 text-white p-4 rounded-2xl font-bold hover:bg-emerald-700 transition flex items-center justify-center gap-2 shadow-lg shadow-emerald-500/20"><i class="fas fa-plus-circle"></i> New Summary</button>
                    <button onclick="createQuick('Note')" class="col-span-1 bg-white border border-emerald-100 text-emerald-700 p-4 rounded-2xl font-bold hover:bg-emerald-50 transition flex items-center justify-center gap-2"><i class="fas fa-sticky-note"></i> New Note</button>
                </div>

                <div class="flex gap-8 border-b border-slate-200 pb-1 mt-6">
                    <button id="tab-summary" class="pb-3 text-lg font-bold text-emerald-600 border-b-2 border-emerald-600 transition" onclick="filterDashboard('Summary')">Summaries</button>
                    <button id="tab-note" class="pb-3 text-lg font-bold text-slate-400 hover:text-emerald-600 transition" onclick="filterDashboard('Note')">Notes</button>
                </div>

                <div class="glass-card rounded-[2rem] p-6 min-h-[400px]">
                    <div class="grid grid-cols-12 gap-4 px-4 pb-4 border-b border-slate-100 text-xs font-bold text-slate-400 uppercase tracking-wider">
                        <div class="col-span-6 md:col-span-5">Topic</div>
                        <div class="col-span-3 md:col-span-3">Labels</div>
                        <div class="hidden md:block md:col-span-2">Date</div>
                        <div class="col-span-3 md:col-span-2 text-right">Action</div>
                    </div>
                    <div id="content-list" class="flex flex-col gap-2 mt-4"></div>
                    <div id="pagination-controls" class="flex justify-between items-center mt-6 pt-4 border-t border-slate-100"></div>
                </div>
            </section>

            <section id="view-editor" class="hidden animate-slide-up h-full">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    
                    <div class="lg:col-span-4 space-y-6">
                        <div class="glass-card p-2 rounded-2xl flex bg-white/50">
                            <button id="type-summary" onclick="setEditorType('Summary')" class="type-toggle active flex-1 py-3 rounded-xl font-bold text-sm transition text-slate-500">Summary</button>
                            <button id="type-note" onclick="setEditorType('Note')" class="type-toggle flex-1 py-3 rounded-xl font-bold text-sm transition text-slate-500">Note</button>
                        </div>
                        <div class="glass-card p-6 rounded-[1.5rem] space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-1 uppercase">Title</label>
                                <input type="text" id="note-title" oninput="updatePreview()" placeholder="Topic name..." class="modern-input w-full p-3 rounded-xl">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-1 uppercase">Tags (comma separated)</label>
                                <input type="text" id="note-label" oninput="updatePreview()" placeholder="Science, Draft, Physics" class="modern-input w-full p-3 rounded-xl">
                            </div>
                        </div>
                        <div class="glass-card p-6 rounded-[1.5rem]">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-sm font-bold text-slate-700">Raw Metadata</h3>
                                <button onclick="askFieldType()" class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded hover:bg-emerald-200 font-bold transition"><i class="fas fa-plus mr-1"></i> Add Data</button>
                            </div>
                            <div id="dynamic-fields-container" class="space-y-3"></div>
                        </div>
                        <div class="glass-card p-6 rounded-[1.5rem]">
                             <label class="block text-xs font-bold text-slate-400 mb-2 uppercase flex justify-between">
                                 <span>Prompt / Body Text</span>
                                 <span class="text-emerald-500 text-[10px] bg-emerald-50 px-2 py-0.5 rounded">Live Sync Active</span>
                             </label>
                            <textarea id="note-prompt" oninput="updatePreview()" class="modern-input w-full h-40 p-3 rounded-xl resize-none text-sm leading-relaxed" placeholder="Type here... Content updates on the right."></textarea>
                        </div>
                    </div>

                    <div class="lg:col-span-8 flex flex-col h-full">
                        <div class="glass-panel flex-grow rounded-[2rem] flex flex-col relative overflow-hidden shadow-2xl ring-1 ring-slate-900/5 bg-white">
                            
                            <div class="bg-slate-50/90 p-3 flex gap-2 items-center border-b border-slate-100 backdrop-blur-sm sticky top-0 z-20 flex-wrap">
                                <button onclick="formatDoc('bold')" class="w-9 h-9 rounded-lg hover:bg-white hover:shadow text-slate-600 font-bold transition"><i class="fas fa-bold"></i></button>
                                <button onclick="formatDoc('italic')" class="w-9 h-9 rounded-lg hover:bg-white hover:shadow text-slate-600 italic transition"><i class="fas fa-italic"></i></button>
                                <button onclick="formatDoc('underline')" class="w-9 h-9 rounded-lg hover:bg-white hover:shadow text-slate-600 underline transition"><i class="fas fa-underline"></i></button>
                                <div class="h-5 w-px bg-slate-300 mx-1"></div>
                                <button onclick="formatDoc('insertUnorderedList')" class="w-9 h-9 rounded-lg hover:bg-white hover:shadow text-slate-600 transition"><i class="fas fa-list-ul"></i></button>
                                <button onclick="formatDoc('insertOrderedList')" class="w-9 h-9 rounded-lg hover:bg-white hover:shadow text-slate-600 transition"><i class="fas fa-list-ol"></i></button>
                                <div class="h-5 w-px bg-slate-300 mx-1"></div>
                                <button onclick="modifyFontSize('increase')" class="w-9 h-9 rounded-lg hover:bg-white hover:shadow text-slate-600 transition"><i class="fas fa-font"></i>+</button>
                                <button onclick="modifyFontSize('decrease')" class="w-9 h-9 rounded-lg hover:bg-white hover:shadow text-slate-600 transition"><i class="fas fa-font"></i>-</button>
                                <div class="h-5 w-px bg-slate-300 mx-1"></div>
                                <label class="color-wrapper w-9 h-9 rounded-lg hover:bg-white hover:shadow text-slate-600 flex items-center justify-center transition" title="Text Color"><i class="fas fa-palette"></i><input type="color" onchange="formatDoc('foreColor', this.value)"></label>
                                <label class="color-wrapper w-9 h-9 rounded-lg hover:bg-white hover:shadow text-slate-600 flex items-center justify-center transition" title="Page Color"><i class="fas fa-fill-drip"></i><input type="color" onchange="changePageColor(this.value)" value="#ffffff"></label>
                                <div class="flex-grow"></div>
                                <span class="text-xs text-slate-400 font-medium mr-2" id="sync-status">Live Preview</span>
                            </div>
                            
                            <div id="editor-content" contenteditable="true" class="flex-grow p-12 bg-white text-slate-800 leading-relaxed text-lg overflow-y-auto"></div>

                            <div class="p-4 border-t border-slate-100 flex justify-end gap-4 bg-slate-50/80 backdrop-blur-md">
                                <button onclick="downloadPDF()" class="px-4 py-3 rounded-xl border border-red-100 text-red-600 font-bold hover:bg-red-50 transition flex items-center gap-2">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                                <button onclick="saveItem()" class="px-8 py-3 rounded-xl bg-didact-main text-white font-bold shadow-lg shadow-emerald-500/20 hover:scale-105 hover:bg-didact-dark transition flex items-center gap-2">
                                    <i class="fas fa-save"></i> Save Item
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="mt-20 bg-slate-900 text-white relative z-10 border-t border-slate-800">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-emerald-600 rounded-lg flex items-center justify-center"><i class="fas fa-brain"></i></div>
                        <div>
                            <span class="text-xl font-bold font-display tracking-tight">Didactax Systems</span>
                            <p class="text-xs text-slate-500">Intelligent Knowledge Management</p>
                        </div>
                    </div>
                    
                    <div class="flex gap-6 text-sm text-slate-400">
                        <a href="#" class="hover:text-emerald-400 transition">Terms of Service</a>
                        <a href="#" class="hover:text-emerald-400 transition">Privacy Policy</a>
                        <a href="#" class="hover:text-emerald-400 transition">Documentation</a>
                    </div>

                    <div class="flex gap-4">
                        <a href="#" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center hover:bg-emerald-600 transition"><i class="fab fa-github"></i></a>
                        <a href="#" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center hover:bg-blue-500 transition"><i class="fab fa-twitter"></i></a>
                    </div>
                </div>
                <div class="border-t border-slate-800 mt-8 pt-8 text-center text-xs text-slate-600">
                    &copy; 2024 Didactax. All rights reserved. Encrypted Locally.
                </div>
            </div>
        </footer>

    </div>

    <script>
        const state = { db: null, view: 'auth', user: null, currentItemId: null, editorType: 'Summary', dashboardFilter: 'Summary', currentPage: 1, itemsPerPage: 5 };
        const DB_NAME = 'DidactaxV2';
        
        /* --- DB & AUTH --- */
        function initDB() {
            return new Promise((resolve) => {
                const req = indexedDB.open(DB_NAME, 1);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('auth')) db.createObjectStore('auth', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('user')) db.createObjectStore('user', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('items')) {
                        const store = db.createObjectStore('items', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('type', 'type', { unique: false });
                    }
                };
                req.onsuccess = (e) => {
                    state.db = e.target.result;
                    checkAuthStatus();
                    resolve(state.db);
                };
            });
        }
        function dbTx(store, mode) { return state.db.transaction(store, mode).objectStore(store); }

        let isRegisterMode = false;
        function checkAuthStatus() {
            dbTx('auth', 'readonly').get('creds').onsuccess = (e) => {
                if (!e.target.result) {
                    toggleAuthMode(true); 
                    document.getElementById('auth-subtext').classList.add('hidden');
                    showModal('Welcome', 'Please create a secure passkey to encrypt your local vault.');
                }
            };
        }
        function toggleAuthMode(forceRegister = false) {
            isRegisterMode = forceRegister || !isRegisterMode;
            document.querySelector('#view-auth h1').textContent = isRegisterMode ? "Create Access Key" : "Didactax.";
            document.getElementById('auth-btn').textContent = isRegisterMode ? "Register System" : "Unlock System";
            document.getElementById('auth-subtext').textContent = isRegisterMode ? "Already registered? Login." : "First time? Create access key.";
            document.getElementById('reg-fields').classList.toggle('hidden', !isRegisterMode);
            document.getElementById('auth-subtext').classList.toggle('hidden', forceRegister);
        }
        function handleAuth() {
            const pass = document.getElementById('auth-pass').value;
            if(!pass) return showModal('Error', 'Password required');
            const tx = dbTx('auth', 'readwrite');
            if (isRegisterMode) {
                const confirm = document.getElementById('auth-pass-confirm').value;
                if(pass !== confirm) return showModal('Error', 'Passwords do not match');
                tx.put({ id: 'creds', key: btoa(pass) }); 
                dbTx('user', 'readwrite').put({ id: 'profile', name: 'New User', role: 'Explorer', bio: 'Ready to learn', streak: 0, lastLogin: null, logs: [] });
                showModal('Success', 'System initialized. Please login.', () => { toggleAuthMode(false); document.getElementById('auth-pass').value = ''; });
            } else {
                tx.get('creds').onsuccess = (e) => {
                    if(e.target.result && e.target.result.key === btoa(pass)) enterApp();
                    else showModal('Access Denied', 'Incorrect Passkey');
                };
            }
        }
        function handleLogout() {
            document.getElementById('app-wrapper').classList.add('hidden');
            document.getElementById('view-auth').classList.remove('hidden');
            document.getElementById('auth-pass').value = '';
            state.user = null;
        }
        function enterApp() {
            document.getElementById('view-auth').classList.add('hidden');
            document.getElementById('app-wrapper').classList.remove('hidden');
            document.getElementById('app-wrapper').classList.add('flex');
            loadUserProfile();
            router('home');
        }

        /* --- USER & LOGS --- */
        function loadUserProfile() {
            dbTx('user', 'readwrite').get('profile').onsuccess = (e) => {
                state.user = e.target.result;
                const today = new Date().toDateString();
                if (state.user.lastLogin !== today) {
                    state.user.streak = (state.user.lastLogin === new Date(Date.now() - 864e5).toDateString()) ? state.user.streak + 1 : 1;
                    state.user.lastLogin = today;
                    logAction('Daily Login');
                    dbTx('user', 'readwrite').put(state.user);
                }
                updateUserUI();
            };
        }
        function updateUserUI() {
            document.getElementById('profile-name').textContent = state.user.name;
            document.getElementById('profile-role').textContent = state.user.role;
            document.getElementById('profile-bio').textContent = state.user.bio;
            document.getElementById('profile-avatar').textContent = state.user.name.charAt(0).toUpperCase();
            document.getElementById('streak-count').textContent = state.user.streak;
            document.getElementById('activity-log').innerHTML = state.user.logs.map(l => `<li class="border-b border-slate-100 pb-1 flex justify-between"><span>${l.action}</span><span class="text-xs text-slate-300">${l.time}</span></li>`).join('');
        }
        function logAction(action) {
            if(!state.user.logs) state.user.logs = [];
            state.user.logs.unshift({ action, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) });
            if(state.user.logs.length > 20) state.user.logs.pop();
        }
        function editProfile() {
            const html = `<div class="space-y-2 text-left"><input id="edit-name" value="${state.user.name}" class="modern-input w-full p-2 rounded" placeholder="Name"><input id="edit-role" value="${state.user.role}" class="modern-input w-full p-2 rounded" placeholder="Role"><input id="edit-bio" value="${state.user.bio}" class="modern-input w-full p-2 rounded" placeholder="Bio"></div>`;
            showModal('Edit Profile', '', () => {
                state.user.name = document.getElementById('edit-name').value;
                state.user.role = document.getElementById('edit-role').value;
                state.user.bio = document.getElementById('edit-bio').value;
                dbTx('user', 'readwrite').put(state.user);
                updateUserUI();
                document.getElementById('modal-overlay').classList.add('hidden');
            }, true);
            document.getElementById('modal-msg').innerHTML = html;
        }

        /* --- EDITOR CORE --- */
        function setEditorType(type) {
            state.editorType = type;
            document.getElementById('type-summary').classList.toggle('active', type === 'Summary');
            document.getElementById('type-note').classList.toggle('active', type === 'Note');
        }
        function askFieldType() {
            const html = `<div class="grid grid-cols-2 gap-4"><button onclick="addDynamicField('','','input'); closeModal()" class="p-4 rounded-xl border-2 border-slate-100 hover:border-emerald-500 hover:bg-emerald-50 transition"><div class="font-bold text-slate-700">Short Text</div></button><button onclick="addDynamicField('','','textarea'); closeModal()" class="p-4 rounded-xl border-2 border-slate-100 hover:border-emerald-500 hover:bg-emerald-50 transition"><div class="font-bold text-slate-700">Long Text</div></button></div>`;
            document.getElementById('modal-title').textContent = "Select Data Type";
            document.getElementById('modal-msg').innerHTML = html;
            document.getElementById('modal-ok').classList.add('hidden');
            document.getElementById('modal-cancel').classList.remove('hidden');
            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-overlay').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); document.getElementById('modal-ok').classList.remove('hidden'); }

        function addDynamicField(key = '', val = '', type = 'input') {
            const container = document.getElementById('dynamic-fields-container');
            const div = document.createElement('div');
            div.className = "flex gap-2 animate-slide-up dynamic-field-row items-start";
            const inputHtml = type === 'textarea' ? `<textarea oninput="updatePreview()" class="dyn-val modern-input w-2/3 p-2 rounded-xl text-xs min-h-[60px]" placeholder="Value">${val}</textarea>` : `<input type="text" value="${val}" oninput="updatePreview()" class="dyn-val modern-input w-2/3 p-2 rounded-xl text-xs" placeholder="Value">`;
            div.innerHTML = `<input type="text" value="${key}" oninput="updatePreview()" class="dyn-key modern-input w-1/3 p-2 rounded-xl text-xs font-bold h-10" placeholder="Key"><input type="hidden" class="dyn-type" value="${type}">${inputHtml}<button onclick="removeField(this)" class="text-red-400 hover:text-red-600 px-1 pt-2"><i class="fas fa-times"></i></button>`;
            container.appendChild(div);
            updatePreview();
        }
        function removeField(btn) { btn.parentElement.remove(); updatePreview(); }

        function formatDoc(cmd, val=null) { document.execCommand(cmd, false, val); document.getElementById('editor-content').focus(); }
        function modifyFontSize(action) {
            const sel = window.getSelection();
            if (sel.rangeCount) {
                const size = action === 'increase' ? '120%' : '80%';
                if (sel.toString().length > 0) document.execCommand('insertHTML', false, `<span style="font-size: ${size}">${sel.toString()}</span>`);
            }
        }
        function changePageColor(color) { document.getElementById('editor-content').style.backgroundColor = color; }
        function downloadPDF() {
            html2pdf().set({ margin:0.5, filename:`didactax_${Date.now()}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'in',format:'letter',orientation:'portrait'} }).from(document.getElementById('editor-content')).save();
        }

        /* --- LOGIC UPDATE: Labels separate + Metadata in Body --- */
        function updatePreview() {
            const title = document.getElementById('note-title').value || 'Untitled';
            const labelInput = document.getElementById('note-label').value;
            const promptText = document.getElementById('note-prompt').value;
            
            // 1. Process Labels (Multi)
            let metaHeaderHtml = '';
            if(labelInput) {
                // Split by comma, trim whitespace, ignore empty
                const tags = labelInput.split(',').map(s => s.trim()).filter(s => s.length > 0);
                tags.forEach(tag => {
                    metaHeaderHtml += `<span class="preview-badge">${tag}</span>`;
                });
            }

            // 2. Process Custom Fields (Into Body Block)
            let customFieldsHtml = '';
            const fields = document.querySelectorAll('.dynamic-field-row');
            if(fields.length > 0) {
                let rows = '';
                fields.forEach(row => {
                    const k = row.querySelector('.dyn-key').value;
                    const v = row.querySelector('.dyn-val').value;
                    if(k && v) {
                        rows += `<div class="metadata-row"><span class="meta-key">${k}</span><span class="meta-val">${v}</span></div>`;
                    }
                });
                if(rows) customFieldsHtml = `<div class="metadata-block">${rows}</div>`;
            }

            // 3. Process Body
            const bodyHtml = promptText.length > 0 ? promptText.replace(/\n/g, '<br>') : '<p class="text-slate-400 italic">Start typing content...</p>';
            const currentBg = document.getElementById('editor-content').style.backgroundColor;

            // 4. Construct
            const fullHtml = `
                <h1 class="preview-title">${title}</h1>
                <div class="preview-meta">${metaHeaderHtml}</div>
                ${customFieldsHtml} 
                <div class="preview-body">${bodyHtml}</div>
            `;

            const editor = document.getElementById('editor-content');
            editor.innerHTML = fullHtml;
            if(currentBg) editor.style.backgroundColor = currentBg;
            
            document.getElementById('sync-status').className = "text-xs text-emerald-600 font-bold mr-2 animate-pulse";
            setTimeout(() => { document.getElementById('sync-status').className = "text-xs text-slate-400 font-medium mr-2"; }, 500);
        }

        function saveItem() {
            const title = document.getElementById('note-title').value;
            if(!title) return showModal('Error', 'Title is required');
            const dynFields = [];
            document.querySelectorAll('.dynamic-field-row').forEach(div => {
                const k = div.querySelector('.dyn-key').value;
                const v = div.querySelector('.dyn-val').value;
                const t = div.querySelector('.dyn-type').value;
                if(k) dynFields.push({key: k, value: v, type: t});
            });
            const contentDiv = document.getElementById('editor-content');
            const item = {
                title,
                label: document.getElementById('note-label').value,
                prompt: document.getElementById('note-prompt').value,
                content: contentDiv.innerHTML,
                bgColor: contentDiv.style.backgroundColor || '#ffffff',
                customFields: dynFields,
                type: state.editorType,
                date: new Date().toISOString()
            };
            const tx = dbTx('items', 'readwrite');
            if(state.currentItemId) {
                item.id = state.currentItemId;
                tx.put(item).onsuccess = () => { logAction(`Updated ${item.type}`); dbTx('user', 'readwrite').put(state.user); router('dashboard'); };
            } else {
                tx.add(item).onsuccess = () => { logAction(`Created ${item.type}`); dbTx('user', 'readwrite').put(state.user); router('dashboard'); };
            }
        }
        function clearEditor() {
            document.getElementById('note-title').value = '';
            document.getElementById('note-label').value = '';
            document.getElementById('note-prompt').value = '';
            const ed = document.getElementById('editor-content');
            ed.innerHTML = '<p class="text-slate-400 mt-10 text-center">Start typing...</p>';
            ed.style.backgroundColor = '#ffffff';
            document.getElementById('dynamic-fields-container').innerHTML = '';
            state.currentItemId = null;
        }

        /* --- DASHBOARD & ROUTING --- */
        function createQuick(type) { setEditorType(type); router('editor'); }
        function router(view) {
            ['view-home', 'view-dashboard', 'view-editor'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            if(view === 'dashboard') { state.currentPage = 1; loadDashboardItems(); }
            if(view === 'editor' && !state.currentItemId) clearEditor();
            window.scrollTo(0,0);
        }
        function filterDashboard(type) {
            state.dashboardFilter = type; state.currentPage = 1;
            document.getElementById('tab-summary').className = type === 'Summary' ? 'pb-3 text-lg font-bold text-emerald-600 border-b-2 border-emerald-600 transition' : 'pb-3 text-lg font-bold text-slate-400 hover:text-emerald-600 transition';
            document.getElementById('tab-note').className = type === 'Note' ? 'pb-3 text-lg font-bold text-emerald-600 border-b-2 border-emerald-600 transition' : 'pb-3 text-lg font-bold text-slate-400 hover:text-emerald-600 transition';
            loadDashboardItems();
        }
        function loadDashboardItems() {
            dbTx('items', 'readonly').getAll().onsuccess = (e) => {
                let items = (e.target.result || []).filter(i => i.type === state.dashboardFilter).sort((a,b) => new Date(b.date) - new Date(a.date));
                renderPagination(items);
            };
        }
        function renderPagination(allItems) {
            const listContainer = document.getElementById('content-list');
            const paginationContainer = document.getElementById('pagination-controls');
            listContainer.innerHTML = ''; paginationContainer.innerHTML = '';
            if(allItems.length === 0) { listContainer.innerHTML = `<div class="text-center py-10 text-slate-400">No ${state.dashboardFilter}s found. Create one.</div>`; return; }
            const startIndex = (state.currentPage - 1) * state.itemsPerPage;
            const pageItems = allItems.slice(startIndex, startIndex + state.itemsPerPage);
            pageItems.forEach(item => {
                const date = new Date(item.date).toLocaleDateString();
                const labels = item.label ? item.label.split(',').slice(0,2).join(', ') : 'General';
                listContainer.innerHTML += `
                    <div class="dashboard-row glass-card p-4 rounded-xl flex flex-col md:flex-row items-center gap-4 bg-white border border-slate-100">
                        <div class="w-full md:w-5/12 flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg ${item.type === 'Summary' ? 'bg-emerald-100 text-emerald-600' : 'bg-blue-100 text-blue-600'} flex items-center justify-center text-sm"><i class="fas ${item.type === 'Summary' ? 'fa-book-open' : 'fa-sticky-note'}"></i></div>
                            <span class="font-bold text-slate-700 truncate">${item.title}</span>
                        </div>
                        <div class="w-full md:w-3/12"><span class="text-xs font-bold text-slate-500 bg-slate-50 px-2 py-1 rounded border border-slate-200">${labels}</span></div>
                        <div class="hidden md:block md:w-2/12 text-xs text-slate-400">${date}</div>
                        <div class="w-full md:w-2/12 flex justify-end gap-2">
                            <button class="w-8 h-8 rounded-lg hover:bg-slate-100 text-slate-500 hover:text-emerald-600 transition" onclick="editItem(${item.id})"><i class="fas fa-pen"></i></button>
                            <button class="w-8 h-8 rounded-lg hover:bg-red-50 text-slate-300 hover:text-red-500 transition" onclick="deleteItem(${item.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
            });
            const totalPages = Math.ceil(allItems.length / state.itemsPerPage);
            if(totalPages > 1) {
                paginationContainer.innerHTML = `
                    <button onclick="changePage(-1)" ${state.currentPage === 1 ? 'disabled class="opacity-50"' : ''} class="px-4 py-2 text-sm font-bold text-slate-600 hover:text-emerald-600">Prev</button>
                    <span class="text-xs text-slate-400">Page ${state.currentPage} of ${totalPages}</span>
                    <button onclick="changePage(1)" ${state.currentPage === totalPages ? 'disabled class="opacity-50"' : ''} class="px-4 py-2 text-sm font-bold text-slate-600 hover:text-emerald-600">Next</button>`;
            }
        }
        function changePage(d) { state.currentPage += d; loadDashboardItems(); }
        function editItem(id) {
            dbTx('items', 'readonly').get(id).onsuccess = (e) => {
                const item = e.target.result;
                state.currentItemId = item.id;
                setEditorType(item.type);
                document.getElementById('note-title').value = item.title;
                document.getElementById('note-label').value = item.label;
                document.getElementById('note-prompt').value = item.prompt;
                document.getElementById('editor-content').innerHTML = item.content || ''; 
                if(item.bgColor) document.getElementById('editor-content').style.backgroundColor = item.bgColor;
                document.getElementById('dynamic-fields-container').innerHTML = '';
                if(item.customFields) item.customFields.forEach(f => addDynamicField(f.key, f.value, f.type || 'input'));
                router('editor');
            };
        }
        function deleteItem(id) { showModal('Delete Item', 'Are you sure?', () => { dbTx('items', 'readwrite').delete(id).onsuccess = () => { logAction('Deleted Item'); loadDashboardItems(); document.getElementById('modal-overlay').classList.add('hidden'); } }, true); }
        function showModal(title, msg, onOk = null, showCancel = false) {
            const el = document.getElementById('modal-overlay');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-msg').innerHTML = msg; 
            const btnOk = document.getElementById('modal-ok');
            const btnCancel = document.getElementById('modal-cancel');
            btnCancel.classList.toggle('hidden', !showCancel);
            const newOk = btnOk.cloneNode(true);
            btnOk.parentNode.replaceChild(newOk, btnOk);
            newOk.onclick = () => { if(onOk) onOk(); el.classList.add('hidden'); };
            if(showCancel) btnCancel.onclick = () => el.classList.add('hidden');
            el.classList.remove('hidden');
        }

        /* --- 3D BG --- */
        function initThree() {
            const canvas = document.getElementById('three-canvas');
            const scene = new THREE.Scene(); scene.background = new THREE.Color(0xf8fafc); 
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000); camera.position.z = 30;
            const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            const sphere = new THREE.Mesh(new THREE.IcosahedronGeometry(15, 2), new THREE.MeshBasicMaterial({ color: 0x10b981, wireframe: true, transparent: true, opacity: 0.08 }));
            scene.add(sphere);
            const pGeo = new THREE.BufferGeometry(); const pArr = new Float32Array(900);
            for(let i=0; i<900; i++) pArr[i] = (Math.random() - 0.5) * 80;
            pGeo.setAttribute('position', new THREE.BufferAttribute(pArr, 3));
            const particles = new THREE.Points(pGeo, new THREE.PointsMaterial({ size: 0.15, color: 0x059669 }));
            scene.add(particles);
            function animate() { requestAnimationFrame(animate); sphere.rotation.y+=0.002; sphere.rotation.x+=0.001; particles.rotation.y-=0.001; renderer.render(scene, camera); }
            animate();
            window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        }

        window.onload = () => { initThree(); initDB(); };
    </script>
</body>
</html>